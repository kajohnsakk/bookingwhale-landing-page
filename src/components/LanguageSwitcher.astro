---
---

<div class="language-switcher relative">
  <button
    id="languageToggle"
    class="flex items-center space-x-1.5 text-gray-600 hover:text-blue-600 transition-all duration-200 font-medium text-sm lg:text-base relative group touch-manipulation min-h-[44px] px-2 py-1"
  >
    <span id="currentFlag" class="text-sm">ðŸ‡ºðŸ‡¸</span>
    <span id="currentLang" class="text-inherit">EN</span>
    <svg class="w-3 h-3 transform transition-transform duration-200 text-gray-400 group-hover:text-blue-600" id="langArrow" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
    </svg>
    <span
      class="absolute -bottom-1 left-0 w-0 h-0.5 bg-blue-600 transition-all duration-200 group-hover:w-full"
    ></span>
  </button>
  
  <div
    id="languageDropdown"
    class="absolute top-full mt-2 right-0 bg-white backdrop-blur-lg rounded-lg border border-gray-200 shadow-lg py-2 min-w-[120px] opacity-0 invisible transform scale-95 transition-all duration-200 z-[9999]"
  >
    <button
      class="language-option w-full px-3 py-2 text-left hover:bg-gray-50 transition-colors flex items-center space-x-2 text-gray-700 hover:text-gray-900 touch-manipulation text-sm"
      data-lang="en"
    >
      <span class="text-sm">ðŸ‡ºðŸ‡¸</span>
      <span class="font-medium">English</span>
    </button>
    <button
      class="language-option w-full px-3 py-2 text-left hover:bg-gray-50 transition-colors flex items-center space-x-2 text-gray-700 hover:text-gray-900 touch-manipulation text-sm"
      data-lang="th"
    >
      <span class="text-sm">ðŸ‡¹ðŸ‡­</span>
      <span class="font-medium">à¹„à¸—à¸¢</span>
    </button>
  </div>
</div>

<script>
  // Import language store
  import { currentLanguage, translations } from '../stores/language.ts';
  
  let isDropdownOpen = false;
  
  // Elements
  const languageToggle = document.getElementById('languageToggle');
  const languageDropdown = document.getElementById('languageDropdown');
  const currentLangElement = document.getElementById('currentLang');
  const langArrow = document.getElementById('langArrow');
  
  // Toggle dropdown
  function toggleLanguageDropdown(event) {
    // Prevent event bubbling to avoid immediate close
    if (event) {
      event.preventDefault();
      event.stopPropagation();
    }

    isDropdownOpen = !isDropdownOpen;

    if (isDropdownOpen) {
      // Position dropdown correctly on mobile
      positionDropdown();

      languageDropdown?.classList.remove('opacity-0', 'invisible', 'scale-95');
      languageDropdown?.classList.add('opacity-100', 'visible', 'scale-100');
      langArrow?.classList.add('rotate-180');

      // Prevent body scroll on mobile when dropdown is open
      if (window.innerWidth <= 768) {
        document.body.classList.add('dropdown-open');
      }

      // Add a small delay to prevent immediate closing on mobile
      setTimeout(() => {
        document.addEventListener('click', handleOutsideClick);
        document.addEventListener('touchstart', handleOutsideClick);
      }, 10);
    } else {
      closeDropdown();
    }
  }

  // Position dropdown correctly on mobile devices
  function positionDropdown() {
    if (!languageDropdown || !languageToggle) return;

    const isMobile = window.innerWidth <= 768;

    if (isMobile) {
      const toggleRect = languageToggle.getBoundingClientRect();
      const dropdownHeight = 120; // Approximate height of dropdown
      const viewportHeight = window.innerHeight;

      // Check if there's enough space below
      const spaceBelow = viewportHeight - toggleRect.bottom;

      if (spaceBelow < dropdownHeight) {
        // Position above the toggle
        languageDropdown.style.position = 'fixed';
        languageDropdown.style.bottom = (viewportHeight - toggleRect.top + 8) + 'px';
        languageDropdown.style.top = 'auto';
      } else {
        // Position below the toggle
        languageDropdown.style.position = 'fixed';
        languageDropdown.style.top = (toggleRect.bottom + 8) + 'px';
        languageDropdown.style.bottom = 'auto';
      }

      languageDropdown.style.right = (window.innerWidth - toggleRect.right) + 'px';
      languageDropdown.style.left = 'auto';
    } else {
      // Reset positioning for desktop
      languageDropdown.style.position = '';
      languageDropdown.style.top = '';
      languageDropdown.style.bottom = '';
      languageDropdown.style.right = '';
      languageDropdown.style.left = '';
    }
  }

  // Close dropdown function
  function closeDropdown() {
    if (isDropdownOpen) {
      languageDropdown?.classList.add('opacity-0', 'invisible', 'scale-95');
      languageDropdown?.classList.remove('opacity-100', 'visible', 'scale-100');
      langArrow?.classList.remove('rotate-180');
      isDropdownOpen = false;

      // Remove body scroll lock
      document.body.classList.remove('dropdown-open');

      // Remove event listeners
      document.removeEventListener('click', handleOutsideClick);
      document.removeEventListener('touchstart', handleOutsideClick);
    }
  }

  // Handle outside clicks
  function handleOutsideClick(event) {
    const languageSwitcher = document.querySelector('.language-switcher');
    if (languageSwitcher && !languageSwitcher.contains(event.target)) {
      closeDropdown();
    }
  }
  
  // Switch language function
  function switchLanguage(lang, event) {
    // Prevent event bubbling
    if (event) {
      event.preventDefault();
      event.stopPropagation();
    }

    currentLanguage.set(lang);
    localStorage.setItem('language', lang);

    // Update current language display
    const currentFlagElement = document.getElementById('currentFlag');
    if (currentLangElement) {
      currentLangElement.textContent = lang.toUpperCase();
    }
    if (currentFlagElement) {
      currentFlagElement.textContent = lang === 'th' ? 'ðŸ‡¹ðŸ‡­' : 'ðŸ‡ºðŸ‡¸';
    }

    // Update all text content
    updatePageContent();

    // Close dropdown
    closeDropdown();
  }
  
  // Update page content based on current language
  function updatePageContent() {
    const lang = currentLanguage.get();
    const t = translations[lang];
    
    // Update navigation
    const servicesLink = document.querySelector('[data-translate="services"]');
    const featuresLink = document.querySelector('[data-translate="features"]');
    const contactLink = document.querySelector('[data-translate="contact"]');
    const bookNowButtons = document.querySelectorAll('[data-translate="bookNow"]');
    
    if (servicesLink) servicesLink.textContent = t.services;
    if (featuresLink) featuresLink.textContent = t.features;
    if (contactLink) contactLink.textContent = t.contact;
    bookNowButtons.forEach(btn => btn.textContent = t.bookNow);
    
    // Update hero section
    const heroTitle = document.querySelector('[data-translate="heroTitle"]');
    const heroSubtitle = document.querySelector('[data-translate="heroSubtitle"]');
    const heroDescription = document.querySelector('[data-translate="heroDescription"]');
    const heroTagline = document.querySelector('[data-translate="heroTagline"]');
    const trustedBy = document.querySelector('[data-translate="trustedBy"]');
    const startBookingNow = document.querySelector('[data-translate="startBookingNow"]');
    const exploreServices = document.querySelector('[data-translate="exploreServices"]');
    
    if (heroTitle) heroTitle.textContent = t.heroTitle;
    if (heroSubtitle) heroSubtitle.textContent = t.heroSubtitle;
    if (heroDescription) heroDescription.innerHTML = t.heroDescription + '<br><span class="text-lg text-gray-500">' + t.heroTagline + '</span>';
    if (trustedBy) trustedBy.textContent = t.trustedBy;
    if (startBookingNow) startBookingNow.textContent = t.startBookingNow;
    if (exploreServices) exploreServices.textContent = t.exploreServices;
    
    // Update stats
    const activeUsersLabel = document.querySelector('[data-translate="activeUsers"]');
    const uptimeLabel = document.querySelector('[data-translate="uptime"]');
    const supportLabel = document.querySelector('[data-translate="support"]');
    
    if (activeUsersLabel) activeUsersLabel.textContent = t.activeUsers;
    if (uptimeLabel) uptimeLabel.textContent = t.uptime;
    if (supportLabel) supportLabel.textContent = t.support;
    
    // Update all other translatable elements
    document.querySelectorAll('[data-translate]').forEach(element => {
      const key = element.getAttribute('data-translate');
      if (key && t[key]) {
        if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
          element.placeholder = t[key];
        } else {
          // Special handling for elements that might have HTML content
          if (key === 'heroDescription') {
            element.innerHTML = t.heroDescription + '<br><span class="text-base lg:text-lg text-gray-500">' + t.heroTagline + '</span>';
          } else {
            element.textContent = t[key];
          }
        }
      }
    });
  }
  
  // Initialize language on page load
  function initLanguage() {
    const savedLang = localStorage.getItem('language') || 'en';
    currentLanguage.set(savedLang);

    const currentFlagElement = document.getElementById('currentFlag');
    if (currentLangElement) {
      currentLangElement.textContent = savedLang.toUpperCase();
    }
    if (currentFlagElement) {
      currentFlagElement.textContent = savedLang === 'th' ? 'ðŸ‡¹ðŸ‡­' : 'ðŸ‡ºðŸ‡¸';
    }

    updatePageContent();
  }
  
  // Event listeners
  languageToggle?.addEventListener('click', toggleLanguageDropdown);
  languageToggle?.addEventListener('touchstart', (e) => {
    // Prevent double-firing on mobile devices
    e.preventDefault();
    toggleLanguageDropdown(e);
  }, { passive: false });

  // Add event listeners to language options
  document.querySelectorAll('.language-option').forEach(option => {
    const lang = option.getAttribute('data-lang');

    // Click events
    option.addEventListener('click', (e) => switchLanguage(lang, e));

    // Touch events for better mobile support
    option.addEventListener('touchstart', (e) => {
      e.preventDefault();
      switchLanguage(lang, e);
    }, { passive: false });
  });

  // Handle window resize and orientation change
  window.addEventListener('resize', () => {
    if (isDropdownOpen) {
      positionDropdown();
    }
  });

  window.addEventListener('orientationchange', () => {
    setTimeout(() => {
      if (isDropdownOpen) {
        positionDropdown();
      }
    }, 100);
  });
  
  // Make functions globally available
  window.switchLanguage = switchLanguage;
  window.toggleLanguageDropdown = toggleLanguageDropdown;
  
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initLanguage);
</script>

<style>
  .language-switcher {
    position: relative;
    z-index: 1000;
  }

  .language-switcher .language-option:hover {
    background-color: rgba(249, 250, 251, 1);
  }

  .language-option[data-lang="en"]:hover {
    background-color: rgba(59, 130, 246, 0.1);
  }

  .language-option[data-lang="th"]:hover {
    background-color: rgba(34, 197, 94, 0.1);
  }

  /* Mobile-specific styles */
  @media (max-width: 768px) {
    .language-switcher {
      position: relative;
    }

    .language-switcher #languageDropdown {
      position: fixed;
      z-index: 9999;
      min-width: 140px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .language-switcher button {
      min-height: 44px; /* Apple's recommended minimum touch target size */
    }

    .language-option {
      padding: 0.75rem 1rem !important;
      font-size: 1rem;
      min-height: 44px;
      cursor: pointer;
    }

    /* Prevent text selection on mobile */
    .language-switcher * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    /* Better touch feedback */
    .language-option:active {
      background-color: rgba(59, 130, 246, 0.2) !important;
      transform: scale(0.98);
    }

    /* Prevent scroll when dropdown is open */
    body.dropdown-open {
      overflow: hidden;
    }
  }

  /* Ensure dropdown is above everything */
  #languageDropdown {
    z-index: 9999 !important;
  }

  /* Smooth touch interactions */
  .touch-manipulation {
    touch-action: manipulation;
  }
</style>